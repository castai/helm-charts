{{- /* Deprecation warning for pdbMinAvailable */ -}}
{{- if and .Values.pdbMinAvailable (not (hasKey .Values "pdb")) }}
{{- /* pdbMinAvailable is deprecated, use pdb.minAvailable instead */ -}}
{{- end }}
{{- $pdbEnabled := true }}
{{- if hasKey .Values "pdb" }}
{{- $pdbEnabled = .Values.pdb.enabled }}
{{- end }}
{{- if and $pdbEnabled (gt (.Values.replicas | int) 1) }}
{{- if and (.Capabilities.APIVersions.Has "policy/v1") (semverCompare ">= 1.21-0" .Capabilities.KubeVersion.Version) -}}
apiVersion: policy/v1
{{- else -}}
apiVersion: policy/v1beta1
{{- end }}
kind: PodDisruptionBudget
metadata:
  name: castai-cluster-controller
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cluster-controller.labels" . | nindent 4 }}
  {{- $annotations := include "cluster-controller.annotations" . | trim }}
  {{- if $annotations }}
  annotations:
    {{- $annotations | nindent 4 }}
  {{- end }}
spec:
  {{- if and (hasKey .Values "pdb") .Values.pdb.maxUnavailable }}
  maxUnavailable: {{ .Values.pdb.maxUnavailable }}
  {{- else }}
  minAvailable: {{ .Values.pdb.minAvailable | default .Values.pdbMinAvailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      app.kubernetes.io/name: castai-cluster-controller
{{- end }}
