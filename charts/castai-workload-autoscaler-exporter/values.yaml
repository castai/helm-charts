castai:
  # apiKeySecretRef -- Name of secret with Token to be used for authorizing agent access to the API
  # apiKey and apiKeySecretRef are mutually exclusive
  # The referenced secret must provide the token in .data["API_KEY"].
  apiKeySecretRef: ""
  # config map ref -- Name of the config map that contains .data["API_URL"] and .data["CLUSTER_ID"].
  # Can be used instead of apiURL and clusterID values.
  configMapRef: ""
  # apiKey -- Token to be used for authorizing agent access to the API.
  apiKey: ""
  # apiURL -- URL of the CAST AI API.
  apiURL: "https://api.cast.ai"
  # -- Deprecated, use `castai.apiURL` instead (using this value will override `castai.apiURL`).
  apiUrl: ~
  # clusterID -- ID of the cluster the workload-autoscaler is deployed in.
  clusterID: ""
  # clusterIdSecretKeyRef -- Name and Key of secret with ClusterID
  # The referenced secret must provide the ClusterID in .data[<<.Values.castai.clusterIdSecretKeyRef.key>>]
  # The clusterID, configMapRef and clusterIdSecretKeyRef are mutually exclusive.
  clusterIdSecretKeyRef:
    name: ""
    key: "CLUSTER_ID"
  # telemetryURL -- Telemetry endpoint URL for metrics ingestion.
  # When set to "auto" (recommended), the endpoint will be automatically derived from apiURL:
  # - api.cast.ai -> telemetry.prod-master.cast.ai
  # - api.eu.cast.ai -> telemetry.prod-eu.cast.ai
  # - api.dev-master.cast.ai -> telemetry.dev-master.cast.ai
  telemetryURL: "auto"

# workloadWhitelistingEnabled-- Enable whitelisting mode for workload autoscaler exporter. When set to true, only metrics of workloads explicitly labeled as whitelisted will be exported.
workloadWhitelistingEnabled: false

# Pod security context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-pod
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1006
  runAsGroup: 1006
  runAsUser: 1006

# Container security context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# OpenShift-specific configuration
openshift:
  scc:
    # openshift.scc.enabled -- Whether to create SecurityContextConstraints on OpenShift.
    # Set to false to disable SCC creation and rely on OpenShift's default restricted-v2 SCC.
    enabled: true
    # openshift.scc.priority -- Priority for the SecurityContextConstraints resource.
    # Lower priority than OpenShift's anyuid (10) to avoid conflicts during cluster upgrades.
    # Set to null for lowest priority, or customize based on your environment.
    # WARNING: Using priority 10 or higher can cause authentication issues during upgrades.
    # See https://access.redhat.com/solutions/4727461 for details.
    priority: 5
    # openshift.scc.useRestrictedProfile -- When true, uses OpenShift-compatible settings:
    # - runAsUser uses MustRunAsRange instead of MustRunAs (allows OpenShift to assign UID)
    # - fsGroup and supplementalGroups use RunAsAny
    # - readOnlyRootFilesystem removed from SCC (still enforced in pod spec)
    # This prevents the SCC from being selected for unrelated workloads.
    useRestrictedProfile: false

tolerations:
  - key: scheduling.cast.ai/spot
    operator: Exists

# Pod affinity rules.
# Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/os
              operator: NotIn
              values:
                - windows

exporter:
  image:
    repository: us-docker.pkg.dev/castai-hub/library/workload-autoscaler
    pullPolicy: IfNotPresent
    tag: ""
  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # The name of the service account to use.
    # If not set and create is true, a name is generated using the fullname template
    name: ""
  resources:
    limits:
      cpu: 2
      memory: 512Mi
    requests:
      cpu: 500m
      memory: 256Mi

  ## Probes for exporter
  ## Ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/
  readinessProbe:
    # Number of seconds after the container has started before [probe] is initiated
    initialDelaySeconds: 10
    # How often (in seconds) to perform the [probe]
    periodSeconds: 15
    # Number of seconds after which the [probe] times out
    timeoutSeconds: 15
    # Minimum consecutive successes for the [probe] to be considered successful after having failed
    successThreshold: 1
    # Minimum consecutive failures for the [probe] to be considered failed after having succeeded
    failureThreshold: 6
    # HTTP Get probe configuration
    httpGet:
      port: 8081
      path: /healthz

  livenessProbe:
    # Number of seconds after the container has started before [probe] is initiated
    initialDelaySeconds: 10
    # How often (in seconds) to perform the [probe]
    periodSeconds: 15
    # Number of seconds after which the [probe] times out
    timeoutSeconds: 15
    # Minimum consecutive successes for the [probe] to be considered successful after having failed
    successThreshold: 1
    # Minimum consecutive failures for the [probe] to be considered failed after having succeeded
    failureThreshold: 6
    # HTTP Get probe configuration
    httpGet:
      port: 8081
      path: /readyz

  # Defines /metrics ports
  metrics:
    port: 8080
  # Defines health probe port
  healthProbe:
    port: 8081

  config:
    prometheus: []
    #      - datasource: {}
    #          # name: "custom-metrics-endpoint"
    #          # url: http://foo.bar:9090
    #          # timeout: "10s"
    #        metrics:
    #          # Deprecated format (string-based) - will be removed in the future
    #          - "up"
    #          - "go_memstats_heap_inuse_bytes"
    #          # New format (struct-based) - recommended
    #          - name: "up"
    #            query: "up"
    #          - name: "go_memstats_heap_inuse_bytes"
    #            query: "sum(go_memstats_heap_inuse_bytes) by (pod, namespace, container)"
    nodeWorkloads:
      - datasource:
          name: "node-probes"
          kubeletPort: 10250
          metricsPath: /metrics/probes
        transformer: "node-probes"
        metrics:
          - name: "prober_probe_total"

      - datasource:
          name: "node-psi"
          kubeletPort: 10250
          metricsPath: /metrics/cadvisor
        transformer: "node-psi"
        # A given data source is enabled starting from 1.34 where cAdvisor is available as part of kubelet.
        # The '-0' suffix ensures that we enable this data source even if the version is in format: `1.34.0-gke.2037001`.
        # Otherwise, versions with suffixes will be treated as pre-releases, thus will be ignored.
        kubernetesVersion: ">= 1.34.0-0"
        metrics:
          - name: "container_pressure_cpu_waiting_seconds_total"
            # Filter all metrics that are not in the context of a given container but are e.g., pod level.
            filterExpr: container != ""
          - name: "container_pressure_memory_waiting_seconds_total"
            # Filter all metrics that are not in the context of a given container but are e.g., pod level.
            filterExpr: container != ""

    # Deprecated: use failureLimit instead
    failure_limit: ~
    failureLimit: 5
    concurrency: 10
    interval: 15s
    metricsClientInsecure: false
    # Deprecated: use metricLimit instead
    metric_limit: ~
    metricLimit: 5000
    # SidecarNamePatterns is a list of container names that are considered sidecars. If container label
    # is empty, then single non-sidecar container is used as main container. The property has internal
    # default value.
    # sidecarNamePatterns:
      # - "foo"
prometheus:
  enabled: false
  replicaCount: 1
  image:
    repository: us-docker.pkg.dev/castai-hub/library/prom/prometheus
    tag: v3.2.1
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 9090
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  storage:
    size: 2Gi
    retention: "1h"
  scrape: []
  #    - port: 8443
  #      path: /metrics
  #      labels:
  #        foo: bar
  scrapeConfigs: []
#    - job_name: "kubernetes-2112-metrics"
#      kubernetes_sd_configs:
#        - role: pod
#      relabel_configs:
#        - source_labels: [__meta_kubernetes_pod_phase]
#          action: keep
#          regex: "Running"
#        - source_labels: [__meta_kubernetes_namespace]
#          action: replace
#          target_label: namespace
#        - source_labels: [__meta_kubernetes_pod_name]
#          action: replace
#          target_label: pod
#        - source_labels: [__meta_kubernetes_pod_container_name]
#          action: replace
#          target_label: container
#        - source_labels: [__meta_kubernetes_pod_container_port_number]
#          action: keep
#          regex: "2112"
#        - source_labels: [__meta_kubernetes_pod_container_port_number]
#          action: replace
#          target_label: __metrics_path__
#          regex: "2112"
#          replacement: "/metrics"
#    - job_name: "kubernetes-8080-metrics"
#      kubernetes_sd_configs:
#        - role: pod
#      relabel_configs:
#        - source_labels: [__meta_kubernetes_pod_phase]
#          action: keep
#          regex: "Running"
#        - source_labels: [__meta_kubernetes_namespace]
#          action: replace
#          target_label: namespace
#        - source_labels: [__meta_kubernetes_pod_name]
#          action: replace
#          target_label: pod
#        - source_labels: [__meta_kubernetes_pod_container_name]
#          action: replace
#          target_label: container
#        - source_labels: [__meta_kubernetes_pod_container_port_number]
#          action: keep
#          regex: "8080"
#        - source_labels: [__meta_kubernetes_pod_container_port_number]
#          action: replace
#          target_label: __metrics_path__
#          regex: "8080"
#          replacement: "/metrics"

clusterDomain: cluster.local

# -- Used to set additional environment variables for the exporter container via configMaps or secrets.
envFrom: []

fullnameOverride: castai-workload-autoscaler-exporter
