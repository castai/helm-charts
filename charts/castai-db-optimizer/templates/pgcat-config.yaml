{{- if and .Values.pooling .Values.pooling.enabled }}
{{- if not .Values.pooling.databases }}
{{- fail "pooling.databases cannot be empty when pooling is enabled. Please provide at least one database name." }}
{{- end }}
{{- range $index, $endpoint := .Values.endpoints }}
{{- $endpointName := $endpoint.name | default (printf "endpoint-%d" $index) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "name" $ }}-pgcat-config-{{ $endpointName }}
  labels:
    {{- include "labels" $ | nindent 4 }}
  annotations:
    {{- include "annotations" $ | nindent 4 }}
data:
  pgcat.toml: |
    [general]
    host = "{{ $.Values.pooling.listenAddress | default "0.0.0.0" }}"
    port = {{ add $endpoint.port 100 }}
    admin_username = "{{ $.Values.pooling.adminUsername | default "admin" }}"
    admin_password = "{{ $.Values.pooling.adminPassword | default "admin" }}"
    
    # Connection settings
    connect_timeout = {{ $.Values.pooling.connectTimeout | default 1000 }}
    idle_timeout = {{ $.Values.pooling.idleTimeout | default 30000 }}
    server_lifetime = {{ $.Values.pooling.serverLifetime | default "86400000" | int }}
    server_tls = {{ $.Values.pooling.serverTLS | default true }}
    verify_server_certificate = {{ $.Values.pooling.verifyServerCertificate | default false }}
    tls_certificate = "{{ $.Values.pooling.tlsCertificate | default "/etc/tls/cert.pem" }}"
    tls_private_key = "{{ $.Values.pooling.tlsPrivateKey | default "/etc/tls/key.pem" }}"

    # Health check settings
    healthcheck_timeout = {{ $.Values.pooling.healthcheckTimeout | default 1000 }}
    healthcheck_delay = {{ $.Values.pooling.healthcheckDelay | default 30000 }}
    ban_time = {{ $.Values.pooling.banTime | default 60 }}
    
    # Logging
    log_client_connections = {{ $.Values.pooling.logClientConnections | default false }}
    log_client_disconnections = {{ $.Values.pooling.logClientDisconnections | default false }}

    {{- range $dbIndex, $database := $.Values.pooling.databases }}
    [pools.{{ $database }}]
    pool_mode = "{{ $.Values.pooling.poolMode | default "transaction" }}"
    load_balancing_mode = "{{ $.Values.pooling.loadBalancingMode | default "random" }}"
    default_role = "{{ $.Values.pooling.defaultRole | default "any" }}"
    
    [pools.{{ $database }}.shards."0"]
    database = "{{ $database }}"
    servers = [
      ["{{ required "endpoint hostname must be provided" $endpoint.hostname }}", {{ required "endpoint targetPort is required" $endpoint.targetPort }}, "primary"]
    ]
    
    [pools.{{ $database }}.users."0"]
    username = "${PGCAT_USERNAME}"
    password = "${PGCAT_PASSWORD}"
    pool_size = {{ $.Values.pooling.poolSize | default 20 }}
    min_pool_size = {{ $.Values.pooling.minPoolSize | default 5 }}
    {{- end }}

{{- end }}
{{- end }}
