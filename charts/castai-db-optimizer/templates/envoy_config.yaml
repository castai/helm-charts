apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "name" . }}-envoy-config
  labels:
    {{- include "labels" . | nindent 4 }}
  annotations:
    {{- include "annotations" . | nindent 4 }}
data:
  envoy-config.yaml: |-
    node:
      cluster: castai
      id: castai-router

    bootstrap_extensions:
      - name: "castai.cache.cappuccino"
        typed_config:
          "@type": type.googleapis.com/castai.cache.cappuccino.v1.CappuccinoConfig
          stats_prefix: cache
          max_cache_bytes: {{ .Values.proxy.cache.cacheSizeBytes | default 2147483648 | int64 }}
          cache_shards: {{ .Values.proxy.cache.cacheShards | default 64 | int }}
          max_pending_bytes: {{ .Values.proxy.cache.pendingSizeBytes | default 134217728 | int64 }}
          pending_shards: {{ .Values.proxy.cache.pendingShards | default 64 | int }}
      - name: "castai.cache_control"
        typed_config:
          "@type": type.googleapis.com/castai.cache_control.v1.CacheControlConfig
      - name: "castai.grpc.services"
        typed_config:
          "@type": type.googleapis.com/castai.grpc.config.v1.Services
          enabled: true
          query_processor_service:
            envoy_grpc:
              cluster_name: query_processor_service

    stats_config:
      stats_matcher:
        exclusion_list:
          patterns:
            - prefix: cluster.castai_cache_

    static_resources:
      listeners:
        {{- range $index, $endpoint := .Values.endpoints}}
        - name: endpoint_listener_{{$index}}
          address:
            socket_address:
              address: 0.0.0.0
              port_value: {{ $endpoint.port }}
          filter_chains:
            - filters:
              {{- if $.Values.proxy.networkDebug | default false }}
                - name: castai.filters.dump
                  typed_config:
                    "@type": type.googleapis.com/castai.filters.dump.v1.Dump
                    name: frontend_{{ $index }}
              {{- end }}
              {{- if eq $.Values.protocol "PostgreSQL" }}
                - name: castai.filters.postgres
                  typed_config:
                    "@type": type.googleapis.com/castai.filters.postgres.v1.PostgresConfig
              {{- else if eq $.Values.protocol "MySQL" }}
                - name: castai.filters.mysql
                  typed_config:
                    "@type": type.googleapis.com/castai.filters.mysql.v1.MySQLConfig
              {{- else }}
              {{- fail (printf "invalid protocol value '%s', available values: 'PostgreSQL', 'MySQL'" .Values.protocol ) -}}
              {{- end }}
              {{- if $.Values.proxy.networkDebug | default false }}
                - name: castai.filters.dump
                  typed_config:
                    "@type": type.googleapis.com/castai.filters.dump.v1.Dump
                    name: backend_{{ $index }}
              {{- end }}
                - name: envoy.filters.network.tcp_proxy
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                    stat_prefix: proxy_egress_{{ $index }}
                    cluster: endpoint_upstream_{{ $index }}
                    idle_timeout: 0s
              transport_socket:
                name: envoy.transport_sockets.starttls
                typed_config:
                {{- if eq $.Values.protocol "MySQL" }}
                  "@type": type.googleapis.com/castai.transport_sockets.mysql_starttls.v1.MySqlStartTlsConfig
                {{- else }}
                  "@type": type.googleapis.com/envoy.extensions.transport_sockets.starttls.v3.StartTlsConfig
                {{- end }}
                  tls_socket_config:
                    common_tls_context:
                      {{- include "proxy.tls.certificates" $ | nindent 22  }}
          socket_options:
            - description: "enable keep-alive"
              level: 1 # means socket level options
              name: 9 # means the keep-alive parameter
              int_value: 1 # a nonzero value means "yes"
              state: STATE_PREBIND
            - description: "idle time before first keep-alive probe is sent"
              level: 6 # IPPROTO_TCP
              name: 4 # TCP_KEEPIDLE parameter - The time (in seconds) the connection needs to remain idle before TCP starts sending keepalive probes
              int_value: 60 # seconds
              state: STATE_PREBIND
            - description: "keep-alive interval"
              level: 6 # IPPROTO_TCP
              name: 5 # the TCP_KEEPINTVL parameter - The time (in seconds) between individual keepalive probes.
              int_value: 20 # seconds
              state: STATE_PREBIND
            - description: "keep-alive probes count"
              level: 6 # IPPROTO_TCP
              name: 6 # the TCP_KEEPCNT parameter - The maximum number of keepalive probes TCP should send before dropping the connection
              int_value: 2 # number of failed probes
              state: STATE_PREBIND
        {{- end }}

      clusters:
        {{- range $index, $endpoint := .Values.endpoints}}
        - name: endpoint_upstream_{{ $index }}
          type: {{ if $endpoint.serviceDiscovery }}{{ default "LOGICAL_DNS" $endpoint.serviceDiscovery.type }}{{ else }}LOGICAL_DNS{{ end }}
          dns_lookup_family: {{ if $endpoint.serviceDiscovery }}{{ default "ALL" $endpoint.serviceDiscovery.dns_lookup_family }}{{ else }}ALL{{ end }}
          {{- if and $endpoint.serviceDiscovery $endpoint.serviceDiscovery.respect_dns_ttl }}
          respect_dns_ttl: {{ $endpoint.serviceDiscovery.respect_dns_ttl }}
          {{- end }}
          {{- if and $endpoint.serviceDiscovery $endpoint.serviceDiscovery.dns_refresh_rate }}
          dns_refresh_rate: {{ $endpoint.serviceDiscovery.dns_refresh_rate }}
          {{- end }}
          connect_timeout: 1s
          upstream_connection_options:
            tcp_keepalive:
              keepalive_interval: 5
              keepalive_probes: 3
              keepalive_time: 30
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: {{ $.Values.proxy.connectionLimits.maxConnections | default 10000 }}
                max_pending_requests: {{ $.Values.proxy.connectionLimits.maxPendingRequests | default 1024 }}
                max_requests: {{ $.Values.proxy.connectionLimits.maxRequests | default 1024 }}
                max_retries: {{ $.Values.proxy.connectionLimits.maxRetries | default 3 }}
          load_assignment:
            cluster_name: endpoint_upstream_{{ $index }}
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          {{- if and $.Values.pooling $.Values.pooling.enabled }}
                          address: 127.0.0.1 # local pgcat container running in the same pod
                          port_value: {{ add $endpoint.port 100 }} # pgcat port
                          {{- else if and $.Values.cloudSqlProxy $.Values.cloudSqlProxy.enabled }}
                          address: 127.0.0.1 # local cloud-sql-proxy container running in the same pod
                          port_value: {{ add $.Values.cloudSqlProxy.basePort $index }}
                          {{- else }}
                          address: {{ required "endpoint hostname must be provided" $endpoint.hostname }} # upstream database host
                          port_value: {{ required "endpoint targetPort is required" $endpoint.targetPort }} # upstream database port
                          {{- end }}
          transport_socket:
            name: envoy.transport_sockets.start_tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.starttls.v3.UpstreamStartTlsConfig
              tls_socket_config:
                sni: {{ required "endpoint hostname must be provided" $endpoint.hostname }}
                common_tls_context:
                  tls_params:
                    tls_maximum_protocol_version: TLSv1_3
        {{- end }}

        - name: query_processor_service
          type: LOGICAL_DNS
          connect_timeout: 1s
          http2_protocol_options:
            max_concurrent_streams: 100
            initial_stream_window_size: 1048576
            initial_connection_window_size: 1048576
          load_assignment:
            cluster_name: query_processor_service
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 9050
    admin:
      access_log_path: "/tmp/admin_access.log"
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901
