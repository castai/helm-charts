{{- if and .Values.pgdog .Values.pgdog.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "name" . }}-pgdog-health-check
  labels:
    {{- include "labels" . | nindent 4 }}
  annotations:
    {{- include "annotations" . | nindent 4 }}
data:
  health-check.sh: |
    #!/bin/sh
    set -e

    CONFIG_FILE="/etc/pgdog/pgdog.toml"
    CHECKSUM_FILE="/tmp/pgdog-config-checksum"

    # Report not ready if config file doesn't exist yet
    if [ ! -f "$CONFIG_FILE" ]; then
      echo "Config file not available yet"
      exit 1
    fi

    # Calculate current checksum
    CURRENT_CHECKSUM=$(sha256sum "$CONFIG_FILE" | awk '{print $1}')

    # Check if this is first run or if checksum changed
    SHOULD_SIGHUP=false

    if [ -f "$CHECKSUM_FILE" ]; then
      PREVIOUS_CHECKSUM=$(cat "$CHECKSUM_FILE")

      # If checksum changed, send SIGHUP to pgdog
      if [ "$CURRENT_CHECKSUM" != "$PREVIOUS_CHECKSUM" ]; then
        echo "Config file changed, sending SIGHUP to pgdog"
        SHOULD_SIGHUP=true
      fi
    else
      # First run - config file now exists, send SIGHUP
      echo "Config file detected for first time, sending SIGHUP to pgdog"
      SHOULD_SIGHUP=true
    fi

    # Send SIGHUP if needed
    if [ "$SHOULD_SIGHUP" = "true" ]; then
      # Find pgdog process and send SIGHUP
      PGDOG_PID=$(pgrep -f "pgdog.*--config" || true)
      if [ -n "$PGDOG_PID" ]; then
        kill -HUP "$PGDOG_PID"
        echo "SIGHUP sent to pgdog (PID: $PGDOG_PID)"
      else
        echo "Warning: pgdog process not found"
      fi
    fi

    # Update stored checksum
    echo "$CURRENT_CHECKSUM" > "$CHECKSUM_FILE"

    exit 0
{{- end }}
