{{- if and .Values.model.cache.enabled .Values.useRunAiStreamer (ne .Values.model.sourceRegistry "hf") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "vllm.fullname" . }}-startup-script
  labels:
    {{- include "vllm.labels" . | nindent 4 }}
data:
  startup.sh: |
    #!/bin/bash
    set -e

    SOURCE_MODEL="{{- if eq .Values.model.sourceRegistry "gcs" -}}gs://{{ .Values.model.name }}{{- else -}}s3://{{ .Values.model.name }}{{- end -}}"

    CACHE_BUCKET="{{ .Values.model.cache.bucket }}"
    CACHE_DIR="{{ include "model.dirName" . }}"
    CACHE_MODEL="{{- if eq .Values.model.cache.bucketType "gcs" -}}gs://${CACHE_BUCKET}/${CACHE_DIR}{{- else -}}s3://${CACHE_BUCKET}/${CACHE_DIR}{{- end -}}"

    CACHE_READY_FILE="/cache-ready/{{ .Values.model.cache.bucket }}/{{ include "model.dirName" . }}/.copy.manifest"

    if [[ -f "${CACHE_READY_FILE}" ]]; then
      echo "Cache ready marker found at ${CACHE_READY_FILE}, using cache model: ${CACHE_MODEL}"
      MODEL_PATH="${CACHE_MODEL}"
      if [[ "{{ .Values.model.cache.bucketType }}" == "gcs" ]]; then
        export GOOGLE_APPLICATION_CREDENTIALS="${CACHE_GOOGLE_APPLICATION_CREDENTIALS}"
      else
        export AWS_ACCESS_KEY_ID="${CACHE_AWS_ACCESS_KEY_ID}"
        export AWS_SECRET_ACCESS_KEY="${CACHE_AWS_SECRET_ACCESS_KEY}"
        export AWS_REGION="${CACHE_AWS_REGION}"
        export AWS_DEFAULT_REGION="${CACHE_AWS_REGION}"
        export AWS_ENDPOINT_URL="${CACHE_AWS_ENDPOINT_URL}"
      fi
    else
      echo "Cache not ready, using source model: ${SOURCE_MODEL}"
      MODEL_PATH="${SOURCE_MODEL}"
      if [[ "{{ .Values.model.sourceRegistry }}" == "gcs" ]]; then
        export GOOGLE_APPLICATION_CREDENTIALS="${SOURCE_GCS_CREDENTIALS_FILE}"
      else
        export AWS_ACCESS_KEY_ID="${SOURCE_S3_ACCESS_KEY_ID}"
        export AWS_SECRET_ACCESS_KEY="${SOURCE_S3_SECRET_ACCESS_KEY}"
        export AWS_REGION="${SOURCE_S3_REGION}"
        export AWS_DEFAULT_REGION="${SOURCE_S3_REGION}"
        export AWS_ENDPOINT_URL="${SOURCE_S3_ENDPOINT}"
      fi
    fi

    exec vllm serve --model="${MODEL_PATH}" "$@"
{{- end }}

